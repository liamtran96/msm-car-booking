---
id: database-schema
title: Lược đồ Cơ sở dữ liệu
sidebar_position: 3
---

import ZoomableMermaid from '@site/src/components/ZoomableMermaid';

# Lược đồ Cơ sở dữ liệu

Tài liệu này mô tả các mô hình dữ liệu PostgreSQL cho Hệ thống MSM Car Booking.

## Stack Công nghệ

- **Backend**: NestJS với TypeORM
- **Cơ sở dữ liệu**: PostgreSQL
- **Frontend**: React
- **Hạ tầng**: Docker

---

## Sơ đồ Quan hệ Entity

### Quan hệ giữa các Entity

| Từ | Quan hệ | Đến | Mô tả |
|----|---------|-----|-------|
| **departments** | 1:N | users | Một phòng ban có nhiều người dùng |
| **departments** | 1:N | bookings | Một phòng ban chi trả cho nhiều booking (phân bổ chi phí) |
| **departments** | 1:N | trip_reports | Một phòng ban được tính phí cho nhiều chuyến đi |
| **users** | 1:N | vehicles | Một tài xế có thể được gán cho nhiều xe |
| **users** | 1:N | bookings | Một người dùng (requester) có thể tạo nhiều booking |
| **users** | 1:N | bookings | Một người dùng (driver) có thể được gán cho nhiều booking |
| **users** | 1:N | bookings | Một người dùng có thể hủy nhiều booking |
| **users** | 1:N | notifications | Một người dùng nhận nhiều thông báo |
| **users** | 1:N | odometer_logs | Một người dùng ghi nhận nhiều chỉ số odometer |
| **users** | 1:N | driver_shifts | Một tài xế làm việc nhiều ca |
| **users** | 1:N | vehicle_maintenance | Một người dùng thực hiện/ghi nhận nhiều bản ghi bảo trì |
| **users** | 1:N | system_configs | Một người dùng cập nhật nhiều cấu hình hệ thống |
| **users** | 1:N | audit_logs | Những thay đổi của người dùng được theo dõi trong audit logs |
| **users** | 1:N | trip_reports | Một tài xế xuất hiện trong nhiều báo cáo chuyến đi |
| **users** | 1:N | trip_reports | Một requester xuất hiện trong nhiều báo cáo chuyến đi |
| **vehicles** | 1:N | km_quotas | Một xe có hạn mức km hàng tháng |
| **vehicles** | 1:N | bookings | Một xe được gán cho nhiều booking |
| **vehicles** | 1:N | gps_locations | Một xe phát ra nhiều bản ghi vị trí GPS |
| **vehicles** | 1:N | odometer_logs | Một xe có nhiều chỉ số odometer |
| **vehicles** | 1:N | vehicle_maintenance | Một xe có nhiều bản ghi bảo trì |
| **vehicles** | 1:N | trip_reports | Một xe được sử dụng trong nhiều báo cáo chuyến đi |
| **bookings** | 1:N | trip_stops | Một booking chứa nhiều điểm dừng (đón/trả/trung gian) |
| **bookings** | 1:N | notifications | Một booking kích hoạt nhiều thông báo |
| **bookings** | 1:N | odometer_logs | Một booking có chỉ số odometer đầu/cuối |
| **bookings** | 1:1 | trip_reports | Một booking hoàn thành tạo ra một báo cáo chuyến đi |
| **bookings** | 1:1 | external_dispatches | Một booking có thể được chuyển hướng đến một nhà cung cấp bên ngoài |
| **bookings** | 1:N | trip_expenses | Một booking có thể có nhiều chi phí |
| **bookings** | 1:N | trip_events | Một booking có nhiều sự kiện timeline |
| **pickup_points** | 1:N | trip_stops | Một điểm đón được sử dụng trong nhiều trip stops |

<ZoomableMermaid
  title="MSM Car Booking - Sơ đồ Quan hệ Entity"
  chart={`erDiagram
    %% ==================== CORE ENTITIES ====================
    departments {
        uuid id PK
        varchar name
        varchar code UK
        varchar cost_center
        boolean is_active
        timestamp created_at
        timestamp updated_at
    }

    users {
        uuid id PK
        varchar email UK
        varchar password_hash
        varchar full_name
        varchar phone
        user_role role
        user_segment user_segment
        uuid department_id FK
        boolean is_active
        timestamp created_at
        timestamp updated_at
    }

    vehicles {
        uuid id PK
        varchar license_plate UK
        varchar brand
        varchar model
        int year
        int capacity
        vehicle_type vehicle_type
        vehicle_status status
        decimal current_odometer_km
        varchar gps_device_id
        uuid assigned_driver_id FK
        boolean is_active
        timestamp created_at
        timestamp updated_at
    }

    km_quotas {
        uuid id PK
        uuid vehicle_id FK
        date month
        decimal quota_km
        decimal tolerance_km
        decimal used_km
        timestamp created_at
        timestamp updated_at
    }

    pickup_points {
        uuid id PK
        varchar name
        varchar address
        decimal latitude
        decimal longitude
        point_type point_type
        boolean is_active
        timestamp created_at
        timestamp updated_at
    }

    %% ==================== BOOKING ENTITIES ====================
    bookings {
        uuid id PK
        varchar booking_code UK
        uuid requester_id FK
        uuid department_id FK
        booking_type booking_type
        booking_status status
        date scheduled_date
        time scheduled_time
        date end_date
        text purpose
        int passenger_count
        text notes
        uuid assigned_vehicle_id FK
        uuid assigned_driver_id FK
        decimal estimated_km
        decimal actual_km
        timestamp cancelled_at
        uuid cancelled_by FK
        cancellation_reason cancellation_reason
        timestamp created_at
        timestamp updated_at
    }

    trip_stops {
        uuid id PK
        uuid booking_id FK
        uuid pickup_point_id FK
        varchar custom_address
        decimal latitude
        decimal longitude
        int stop_order
        stop_type stop_type
        time scheduled_time
        timestamp actual_arrival
        timestamp created_at
    }

    external_dispatches {
        uuid id PK
        uuid booking_id FK
        external_provider provider
        varchar provider_booking_id
        varchar provider_driver_name
        decimal estimated_cost
        decimal actual_cost
        text dispatch_reason
        timestamp dispatched_at
        timestamp completed_at
    }

    %% ==================== GPS & TRACKING ====================
    gps_locations {
        uuid id PK
        uuid vehicle_id FK
        decimal latitude
        decimal longitude
        decimal speed_kmh
        decimal heading
        timestamp recorded_at
    }

    odometer_logs {
        uuid id PK
        uuid vehicle_id FK
        uuid booking_id FK
        decimal reading_km
        reading_type reading_type
        timestamp recorded_at
        uuid recorded_by FK
    }

    %% ==================== DRIVER MANAGEMENT ====================
    driver_shifts {
        uuid id PK
        uuid driver_id FK
        date shift_date
        time start_time
        time end_time
        shift_status status
        timestamp actual_start
        timestamp actual_end
        timestamp created_at
        timestamp updated_at
    }

    %% ==================== VEHICLE MAINTENANCE ====================
    vehicle_maintenance {
        uuid id PK
        uuid vehicle_id FK
        maintenance_type maintenance_type
        text description
        decimal odometer_at_service
        decimal cost
        varchar vendor_name
        timestamp started_at
        timestamp completed_at
        decimal next_service_km
        date next_service_date
        uuid performed_by FK
    }

    %% ==================== NOTIFICATIONS ====================
    notifications {
        uuid id PK
        uuid user_id FK
        uuid booking_id FK
        notification_channel channel
        notification_type notification_type
        varchar title
        text message
        notification_status status
        timestamp sent_at
        timestamp created_at
    }

    %% ==================== REPORTING & CONFIG ====================
    trip_reports {
        uuid id PK
        uuid booking_id FK
        uuid vehicle_id FK
        uuid driver_id FK
        uuid requester_id FK
        uuid department_id FK
        date trip_date
        decimal start_km
        decimal end_km
        decimal total_km
        int duration_minutes
        decimal cost_estimate
        timestamp created_at
    }

    system_configs {
        uuid id PK
        varchar key UK
        jsonb value
        text description
        uuid updated_by FK
        timestamp updated_at
    }

    audit_logs {
        uuid id PK
        varchar table_name
        uuid record_id
        varchar action
        jsonb old_values
        jsonb new_values
        text changed_fields
        uuid changed_by FK
        timestamp changed_at
    }

    booking_sequences {
        date date_key PK
        int last_seq
    }

    %% ==================== RELATIONSHIPS ====================
    departments ||--o{ users : "employs"
    departments ||--o{ bookings : "pays_for"
    departments ||--o{ trip_reports : "billed_to"

    users ||--o{ vehicles : "assigned_driver"
    users ||--o{ bookings : "requests"
    users ||--o{ bookings : "drives"
    users ||--o{ bookings : "cancels"
    users ||--o{ notifications : "receives"
    users ||--o{ odometer_logs : "records"
    users ||--o{ driver_shifts : "works"
    users ||--o{ vehicle_maintenance : "performs"
    users ||--o{ system_configs : "updates"
    users ||--o{ audit_logs : "changes"
    users ||--o{ trip_reports : "driver_report"
    users ||--o{ trip_reports : "requester_report"

    vehicles ||--o{ km_quotas : "has_quota"
    vehicles ||--o{ bookings : "assigned_to"
    vehicles ||--o{ gps_locations : "tracked_by"
    vehicles ||--o{ odometer_logs : "logged"
    vehicles ||--o{ vehicle_maintenance : "serviced"
    vehicles ||--o{ trip_reports : "used_in"

    bookings ||--o{ trip_stops : "contains"
    bookings ||--o{ notifications : "triggers"
    bookings ||--o{ odometer_logs : "recorded_for"
    bookings ||--o| trip_reports : "generates"
    bookings ||--o| external_dispatches : "redirected_to"

    pickup_points ||--o{ trip_stops : "location_for"
`} />

### Chú thích Sơ đồ

| Ký hiệu | Ý nghĩa |
|---------|---------|
| `PK` | Primary Key |
| `FK` | Foreign Key |
| `UK` | Unique Key |
| `\|\|--o{` | Một-Nhiều |
| `\|\|--o\|` | Một-Một (tùy chọn) |

### Nhóm Entity

#### Entity Cốt lõi
| Bảng | Mô tả |
|------|-------|
| `departments` | Đơn vị tổ chức cho theo dõi chi phí |
| `users` | Tất cả người dùng hệ thống (admins, drivers, employees) |
| `vehicles` | Xe đội với theo dõi GPS |
| `km_quotas` | Hạn mức km hàng tháng cho mỗi xe |
| `pickup_points` | Các địa điểm được định nghĩa trước và tùy chỉnh |

#### Hệ thống Đặt chỗ
| Bảng | Mô tả |
|------|-------|
| `bookings` | Bản ghi đặt chỗ chính |
| `trip_stops` | Các điểm dừng riêng lẻ trong booking |
| `external_dispatches` | Bản ghi chuyển hướng Grab/Taxi |
| `booking_sequences` | Tạo mã booking an toàn thread |

#### Theo dõi & GPS
| Bảng | Mô tả |
|------|-------|
| `gps_locations` | Vị trí xe thời gian thực (phân vùng theo tháng) |
| `odometer_logs` | Ghi nhận khoảng cách cho chuyến đi |

#### Vận hành
| Bảng | Mô tả |
|------|-------|
| `driver_shifts` | Lịch trình và availability của tài xế |
| `vehicle_maintenance` | Lịch sử bảo trì và sửa chữa |
| `notifications` | Hàng đợi thông báo đa kênh |

#### Báo cáo & Kiểm toán
| Bảng | Mô tả |
|------|-------|
| `trip_reports` | Dữ liệu phân tích đã denormalize |
| `system_configs` | Cấu hình key-value JSONB |
| `audit_logs` | Theo dõi thay đổi cho các bảng quan trọng |

#### Ứng dụng Tài xế
| Bảng | Mô tả |
|------|-------|
| `trip_expenses` | Chi phí được ghi nhận bởi tài xế trong chuyến đi |
| `trip_events` | Timeline các sự kiện trong quá trình thực hiện chuyến đi |

---

## Entity Cốt lõi

### Users

Lưu trữ tất cả người dùng hệ thống bao gồm nhân viên, tài xế và quản trị viên.

| Cột | Kiểu | Ràng buộc | Mô tả |
|-----|------|-----------|-------|
| id | UUID | PK | Primary key |
| email | VARCHAR | UNIQUE, NOT NULL | Địa chỉ email người dùng |
| password_hash | VARCHAR | NOT NULL | Mật khẩu đã hash |
| full_name | VARCHAR | NOT NULL | Họ tên đầy đủ |
| phone | VARCHAR | | Số điện thoại liên hệ |
| role | ENUM | NOT NULL | Vai trò người dùng (xem bên dưới) |
| user_segment | ENUM | | Loại phân khúc người dùng |
| department_id | UUID | FK → departments | Phòng ban liên kết |
| is_active | BOOLEAN | DEFAULT true | Trạng thái tài khoản |
| created_at | TIMESTAMP | DEFAULT now() | Thời gian tạo |
| updated_at | TIMESTAMP | DEFAULT now() | Thời gian cập nhật cuối |

**Giá trị Enum Role:**
- `ADMIN` - Quản trị viên hệ thống
- `PIC` - Person In Charge
- `GA` - General Affairs
- `DRIVER` - Tài xế xe
- `EMPLOYEE` - Nhân viên thường

**Giá trị Enum User Segment:**
- `DAILY` - Người dùng SIC với lộ trình cố định
- `SOMETIMES` - Người đi công tác với booking thỉnh thoảng

---

### Departments

Các phòng ban tổ chức để theo dõi cost center.

| Cột | Kiểu | Ràng buộc | Mô tả |
|-----|------|-----------|-------|
| id | UUID | PK | Primary key |
| name | VARCHAR | NOT NULL | Tên phòng ban |
| code | VARCHAR | UNIQUE, NOT NULL | Mã phòng ban |
| cost_center | VARCHAR | | Định danh cost center |
| is_active | BOOLEAN | DEFAULT true | Trạng thái phòng ban |
| created_at | TIMESTAMP | DEFAULT now() | Thời gian tạo |
| updated_at | TIMESTAMP | DEFAULT now() | Thời gian cập nhật cuối |

---

### Vehicles

Xe đội có sẵn để đặt chỗ.

| Cột | Kiểu | Ràng buộc | Mô tả |
|-----|------|-----------|-------|
| id | UUID | PK | Primary key |
| license_plate | VARCHAR | UNIQUE, NOT NULL | Số biển xe |
| brand | VARCHAR | NOT NULL | Thương hiệu xe |
| model | VARCHAR | NOT NULL | Model xe |
| year | INT | | Năm sản xuất |
| capacity | INT | NOT NULL | Sức chứa hành khách (chỗ ngồi) |
| vehicle_type | ENUM | NOT NULL | Loại xe |
| status | ENUM | NOT NULL | Trạng thái hiện tại |
| current_odometer_km | DECIMAL | | Chỉ số odometer hiện tại |
| gps_device_id | VARCHAR | | ID thiết bị GPS tracker |
| assigned_driver_id | UUID | FK → users | Tài xế mặc định được gán |
| is_active | BOOLEAN | DEFAULT true | Trạng thái hoạt động xe |
| created_at | TIMESTAMP | DEFAULT now() | Thời gian tạo |
| updated_at | TIMESTAMP | DEFAULT now() | Thời gian cập nhật cuối |

**Giá trị Enum Vehicle Type:**
- `SEDAN` - Sedan tiêu chuẩn
- `SUV` - Sport utility vehicle
- `VAN` - Xe van chở khách
- `BUS` - Bus/minibus

**Giá trị Enum Status:**
- `AVAILABLE` - Sẵn sàng để đặt
- `IN_USE` - Đang trong chuyến đi
- `MAINTENANCE` - Đang bảo trì
- `INACTIVE` - Không hoạt động

---

### KM Quotas

Hạn mức km hàng tháng cho mỗi xe.

| Cột | Kiểu | Ràng buộc | Mô tả |
|-----|------|-----------|-------|
| id | UUID | PK | Primary key |
| vehicle_id | UUID | FK → vehicles, NOT NULL | Xe liên kết |
| month | DATE | NOT NULL | Ngày đầu tiên của tháng |
| quota_km | DECIMAL | NOT NULL | Hạn mức hàng tháng tính bằng km |
| tolerance_km | DECIMAL | | Dung sai cho phép vượt hạn mức |
| used_km | DECIMAL | DEFAULT 0 | Km đã sử dụng trong tháng |
| created_at | TIMESTAMP | DEFAULT now() | Thời gian tạo |
| updated_at | TIMESTAMP | DEFAULT now() | Thời gian cập nhật cuối |

**Ràng buộc Unique:** `UNIQUE(vehicle_id, month)`

---

### Pickup Points

Các địa điểm đón/trả được định nghĩa trước và tùy chỉnh.

| Cột | Kiểu | Ràng buộc | Mô tả |
|-----|------|-----------|-------|
| id | UUID | PK | Primary key |
| name | VARCHAR | NOT NULL | Tên địa điểm |
| address | VARCHAR | NOT NULL | Địa chỉ đầy đủ |
| latitude | DECIMAL | | Vĩ độ GPS |
| longitude | DECIMAL | | Kinh độ GPS |
| point_type | ENUM | NOT NULL | Loại điểm đón |
| is_active | BOOLEAN | DEFAULT true | Trạng thái hoạt động địa điểm |
| created_at | TIMESTAMP | DEFAULT now() | Thời gian tạo |
| updated_at | TIMESTAMP | DEFAULT now() | Thời gian cập nhật cuối |

**Giá trị Enum Point Type:**
- `FIXED` - Địa điểm văn phòng được định nghĩa trước
- `FLEXIBLE` - Địa điểm tùy chỉnh do người dùng định nghĩa

---

## Entity Booking & Chuyến đi

### Bookings

Bản ghi đặt chỗ/reservation chính.

| Cột | Kiểu | Ràng buộc | Mô tả |
|-----|------|-----------|-------|
| id | UUID | PK | Primary key |
| booking_code | VARCHAR | UNIQUE, NOT NULL | Mã booking dễ đọc |
| requester_id | UUID | FK → users, NOT NULL | Người dùng tạo booking |
| department_id | UUID | FK → departments | Phòng ban để phân bổ chi phí |
| booking_type | ENUM | NOT NULL | Loại booking |
| status | ENUM | NOT NULL | Trạng thái booking hiện tại |
| scheduled_date | DATE | NOT NULL | Ngày chuyến đi theo lịch |
| scheduled_time | TIME | NOT NULL | Giờ chuyến đi theo lịch |
| end_date | DATE | | Ngày kết thúc cho block schedules |
| purpose | TEXT | | Mục đích/lý do chuyến đi |
| passenger_count | INT | NOT NULL | Số lượng hành khách |
| notes | TEXT | | Ghi chú bổ sung |
| assigned_vehicle_id | UUID | FK → vehicles | Xe được gán |
| assigned_driver_id | UUID | FK → users | Tài xế được gán |
| estimated_km | DECIMAL | | Khoảng cách chuyến đi ước tính |
| actual_km | DECIMAL | | Khoảng cách chuyến đi thực tế |
| cancelled_at | TIMESTAMP | | Thời gian booking bị hủy |
| cancelled_by | UUID | FK → users | Người dùng đã hủy |
| cancellation_reason | ENUM | | Lý do hủy |
| cancellation_notes | TEXT | | Chi tiết hủy bổ sung |
| created_at | TIMESTAMP | DEFAULT now() | Thời gian tạo |
| updated_at | TIMESTAMP | DEFAULT now() | Thời gian cập nhật cuối |

**Giá trị Enum Booking Type:**
- `SINGLE_TRIP` - Chuyến một chiều hoặc khứ hồi
- `MULTI_STOP` - Chuyến đi có nhiều điểm dừng
- `BLOCK_SCHEDULE` - Booking định kỳ/block

**Giá trị Enum Status:**
- `PENDING` - Đang chờ xác nhận
- `CONFIRMED` - Booking đã xác nhận
- `ASSIGNED` - Xe và tài xế đã được gán
- `IN_PROGRESS` - Chuyến đi đang diễn ra
- `COMPLETED` - Chuyến đi hoàn thành
- `CANCELLED` - Booking đã hủy
- `REDIRECTED_EXTERNAL` - Chuyển hướng đến nhà cung cấp bên ngoài

**Giá trị Enum Cancellation Reason:**
- `USER_REQUEST` - Người dùng tự hủy booking
- `NO_VEHICLE_AVAILABLE` - Không có xe phù hợp
- `NO_DRIVER_AVAILABLE` - Không có tài xế
- `QUOTA_EXCEEDED` - Vượt hạn mức KM
- `VEHICLE_BREAKDOWN` - Xe gặp sự cố kỹ thuật
- `SCHEDULE_CONFLICT` - Xung đột lịch trình
- `WEATHER` - Điều kiện thời tiết xấu
- `EMERGENCY` - Tình huống khẩn cấp của người dùng
- `DUPLICATE` - Booking trùng lặp
- `OTHER` - Lý do khác (xem ghi chú)

---

### Trip Stops

Các điểm dừng riêng lẻ trong một booking (hỗ trợ đa điểm dừng).

| Cột | Kiểu | Ràng buộc | Mô tả |
|-----|------|-----------|-------|
| id | UUID | PK | Primary key |
| booking_id | UUID | FK → bookings, NOT NULL | Booking cha |
| pickup_point_id | UUID | FK → pickup_points | Điểm đón được định nghĩa trước |
| custom_address | VARCHAR | | Địa chỉ tùy chỉnh nếu linh hoạt |
| latitude | DECIMAL | | Vĩ độ GPS |
| longitude | DECIMAL | | Kinh độ GPS |
| stop_order | INT | NOT NULL | Thứ tự điểm dừng trong chuyến đi |
| stop_type | ENUM | NOT NULL | Loại điểm dừng |
| scheduled_time | TIME | | Thời gian đến theo lịch |
| actual_arrival | TIMESTAMP | | Thời gian đến thực tế |
| created_at | TIMESTAMP | DEFAULT now() | Thời gian tạo |

**Giá trị Enum Stop Type:**
- `PICKUP` - Đón hành khách
- `DROP` - Trả hành khách
- `STOP` - Điểm dừng trung gian

---

### External Dispatches

Bản ghi khi booking được chuyển hướng đến nhà cung cấp bên ngoài (Grab/Taxi).

| Cột | Kiểu | Ràng buộc | Mô tả |
|-----|------|-----------|-------|
| id | UUID | PK | Primary key |
| booking_id | UUID | FK → bookings, NOT NULL | Booking liên quan |
| provider | ENUM | NOT NULL | Nhà cung cấp bên ngoài |
| provider_booking_id | VARCHAR | | Mã tham chiếu của nhà cung cấp |
| provider_driver_name | VARCHAR | | Tên tài xế từ nhà cung cấp |
| provider_vehicle_info | VARCHAR | | Thông tin xe từ nhà cung cấp |
| provider_phone | VARCHAR | | Số điện thoại liên hệ |
| estimated_cost | DECIMAL | | Chi phí ước tính |
| actual_cost | DECIMAL | | Chi phí thực tế |
| dispatch_reason | TEXT | NOT NULL | Lý do không sử dụng xe nội bộ |
| dispatched_at | TIMESTAMP | NOT NULL | Thời gian chuyển hướng |
| completed_at | TIMESTAMP | | Thời gian chuyến đi hoàn thành |
| notes | TEXT | | Ghi chú bổ sung |
| created_at | TIMESTAMP | DEFAULT now() | Thời gian tạo |

**Giá trị Enum External Provider:**
- `GRAB` - Grab ride-hailing
- `GOJEK` - Gojek ride-hailing
- `BE` - Be ride-hailing
- `TAXI_MAI_LINH` - Mai Linh Taxi
- `TAXI_VINASUN` - Vinasun Taxi
- `OTHER` - Nhà cung cấp khác

---

## GPS & Theo dõi

### GPS Locations

Theo dõi vị trí xe thời gian thực.

| Cột | Kiểu | Ràng buộc | Mô tả |
|-----|------|-----------|-------|
| id | UUID | PK | Primary key |
| vehicle_id | UUID | FK → vehicles, NOT NULL | Xe được theo dõi |
| latitude | DECIMAL | NOT NULL | Vĩ độ GPS |
| longitude | DECIMAL | NOT NULL | Kinh độ GPS |
| speed_kmh | DECIMAL | | Tốc độ hiện tại tính bằng km/h |
| heading | DECIMAL | | Hướng đi tính bằng độ |
| recorded_at | TIMESTAMP | NOT NULL | Thời gian ghi nhận |

**Index:** `INDEX(vehicle_id, recorded_at)`

---

### Odometer Logs

Ghi nhận chỉ số odometer xe để theo dõi khoảng cách.

| Cột | Kiểu | Ràng buộc | Mô tả |
|-----|------|-----------|-------|
| id | UUID | PK | Primary key |
| vehicle_id | UUID | FK → vehicles, NOT NULL | Xe |
| booking_id | UUID | FK → bookings | Booking liên quan |
| reading_km | DECIMAL | NOT NULL | Chỉ số odometer |
| reading_type | ENUM | NOT NULL | Loại ghi nhận |
| recorded_at | TIMESTAMP | NOT NULL | Thời gian ghi nhận |
| recorded_by | UUID | FK → users | Người dùng ghi nhận |

**Giá trị Enum Reading Type:**
- `TRIP_START` - Ghi nhận khi bắt đầu chuyến đi
- `TRIP_END` - Ghi nhận khi kết thúc chuyến đi
- `DAILY_CHECK` - Kiểm tra bảo trì hàng ngày

---

## Thông báo

### Notifications

Thông báo hệ thống gửi đến người dùng.

| Cột | Kiểu | Ràng buộc | Mô tả |
|-----|------|-----------|-------|
| id | UUID | PK | Primary key |
| user_id | UUID | FK → users, NOT NULL | Người dùng nhận |
| booking_id | UUID | FK → bookings | Booking liên quan |
| channel | ENUM | NOT NULL | Kênh thông báo |
| notification_type | ENUM | NOT NULL | Loại thông báo |
| title | VARCHAR | NOT NULL | Tiêu đề thông báo |
| message | TEXT | NOT NULL | Nội dung thông báo |
| status | ENUM | NOT NULL | Trạng thái gửi |
| sent_at | TIMESTAMP | | Thời gian thông báo được gửi |
| created_at | TIMESTAMP | DEFAULT now() | Thời gian tạo |

**Giá trị Enum Channel:**
- `APP_PUSH` - Push notification ứng dụng mobile
- `AUTO_CALL` - Cuộc gọi điện thoại tự động
- `SMS` - Tin nhắn văn bản

**Giá trị Enum Notification Type:**
- `BOOKING_CONFIRMED` - Xác nhận booking
- `VEHICLE_ARRIVING` - Xe đang trên đường
- `TRIP_STARTED` - Chuyến đi đã bắt đầu
- `TRIP_COMPLETED` - Chuyến đi hoàn thành
- `BOOKING_CANCELLED` - Booking đã bị hủy

**Giá trị Enum Status:**
- `PENDING` - Chưa gửi
- `SENT` - Đã gửi đến provider
- `DELIVERED` - Xác nhận đã gửi đến
- `FAILED` - Gửi thất bại

---

## Vận hành

### Driver Shifts

Lịch làm việc và theo dõi availability của tài xế.

| Cột | Kiểu | Ràng buộc | Mô tả |
|-----|------|-----------|-------|
| id | UUID | PK | Primary key |
| driver_id | UUID | FK → users, NOT NULL | User tài xế |
| shift_date | DATE | NOT NULL | Ngày ca làm |
| start_time | TIME | NOT NULL | Giờ bắt đầu ca |
| end_time | TIME | NOT NULL | Giờ kết thúc ca |
| status | ENUM | NOT NULL | Trạng thái ca |
| actual_start | TIMESTAMP | | Thời gian check-in thực tế |
| actual_end | TIMESTAMP | | Thời gian check-out thực tế |
| notes | TEXT | | Ghi chú bổ sung |
| created_at | TIMESTAMP | DEFAULT now() | Thời gian tạo |
| updated_at | TIMESTAMP | DEFAULT now() | Thời gian cập nhật cuối |

**Ràng buộc Unique:** `UNIQUE(driver_id, shift_date, start_time)`

**Giá trị Enum Shift Status:**
- `SCHEDULED` - Ca được lên kế hoạch
- `ACTIVE` - Tài xế đang trong ca
- `COMPLETED` - Ca kết thúc bình thường
- `ABSENT` - Tài xế vắng mặt
- `CANCELLED` - Ca bị hủy

---

### Vehicle Maintenance

Lịch sử bảo trì và sửa chữa xe.

| Cột | Kiểu | Ràng buộc | Mô tả |
|-----|------|-----------|-------|
| id | UUID | PK | Primary key |
| vehicle_id | UUID | FK → vehicles, NOT NULL | Xe |
| maintenance_type | ENUM | NOT NULL | Loại bảo trì |
| description | TEXT | NOT NULL | Mô tả công việc |
| odometer_at_service | DECIMAL | | Odometer tại thời điểm bảo trì |
| cost | DECIMAL | | Chi phí bảo trì |
| vendor_name | VARCHAR | | Tên nhà cung cấp dịch vụ |
| started_at | TIMESTAMP | NOT NULL | Thời gian bắt đầu bảo trì |
| completed_at | TIMESTAMP | | Thời gian hoàn thành bảo trì |
| next_service_km | DECIMAL | | Odometer khuyến nghị cho lần bảo trì tiếp theo |
| next_service_date | DATE | | Ngày khuyến nghị cho lần bảo trì tiếp theo |
| performed_by | UUID | FK → users | Người thực hiện/ghi nhận |
| notes | TEXT | | Ghi chú bổ sung |
| created_at | TIMESTAMP | DEFAULT now() | Thời gian tạo |

**Giá trị Enum Maintenance Type:**
- `SCHEDULED` - Bảo trì định kỳ theo lịch
- `REPAIR` - Sửa chữa sau sự cố
- `INSPECTION` - Kiểm tra an toàn
- `TIRE_SERVICE` - Xoay/thay lốp
- `OIL_CHANGE` - Thay dầu và lọc
- `CLEANING` - Vệ sinh nội/ngoại thất
- `OTHER` - Bảo trì khác

---

## Báo cáo & Kiểm toán

### Trip Reports

Dữ liệu chuyến đi đã denormalize cho báo cáo và phân tích.

| Cột | Kiểu | Ràng buộc | Mô tả |
|-----|------|-----------|-------|
| id | UUID | PK | Primary key |
| booking_id | UUID | FK → bookings, NOT NULL | Booking nguồn |
| vehicle_id | UUID | FK → vehicles | Xe được sử dụng |
| driver_id | UUID | FK → users | Tài xế |
| requester_id | UUID | FK → users | Người yêu cầu |
| department_id | UUID | FK → departments | Phòng ban |
| trip_date | DATE | NOT NULL | Ngày chuyến đi |
| start_km | DECIMAL | | Odometer đầu |
| end_km | DECIMAL | | Odometer cuối |
| total_km | DECIMAL | | Tổng khoảng cách |
| duration_minutes | INT | | Thời lượng chuyến đi |
| cost_estimate | DECIMAL | | Chi phí ước tính |
| created_at | TIMESTAMP | DEFAULT now() | Thời gian tạo |

---

### System Configs

Lưu trữ cấu hình key-value.

| Cột | Kiểu | Ràng buộc | Mô tả |
|-----|------|-----------|-------|
| id | UUID | PK | Primary key |
| key | VARCHAR | UNIQUE, NOT NULL | Key cấu hình |
| value | JSONB | NOT NULL | Giá trị cấu hình |
| description | TEXT | | Mô tả cấu hình |
| updated_by | UUID | FK → users | Cập nhật lần cuối bởi |
| updated_at | TIMESTAMP | DEFAULT now() | Thời gian cập nhật cuối |

**Ví dụ Cấu hình:**
```json
{
  "km_tolerance_limit": 50,
  "auto_dispatch_enabled": true,
  "notification_channels": ["APP_PUSH", "AUTO_CALL"]
}
```

---

### Audit Logs

Audit trail toàn diện để theo dõi các thay đổi đối với các bảng quan trọng.

| Cột | Kiểu | Ràng buộc | Mô tả |
|-----|------|-----------|-------|
| id | UUID | PK | Primary key |
| table_name | VARCHAR | NOT NULL | Tên bảng đã thay đổi |
| record_id | UUID | NOT NULL | ID của bản ghi đã thay đổi |
| action | VARCHAR | NOT NULL | INSERT, UPDATE, hoặc DELETE |
| old_values | JSONB | | Giá trị trước đó (UPDATE/DELETE) |
| new_values | JSONB | | Giá trị mới (INSERT/UPDATE) |
| changed_fields | TEXT[] | | Danh sách các trường đã thay đổi |
| changed_by | UUID | FK → users | Người dùng thực hiện thay đổi |
| changed_at | TIMESTAMP | DEFAULT now() | Thời gian thay đổi xảy ra |
| session_user_name | TEXT | | Database session user |
| client_ip | INET | | Địa chỉ IP client |

**Indexes:**
- `INDEX(table_name, record_id)` - Tìm lịch sử cho bản ghi cụ thể
- `INDEX(changed_at DESC)` - Các thay đổi gần đây
- `INDEX(changed_by)` - Các thay đổi theo người dùng

---

### Booking Sequences

Theo dõi sequence mã booking an toàn thread để ngăn race conditions.

| Cột | Kiểu | Ràng buộc | Mô tả |
|-----|------|-----------|-------|
| date_key | DATE | PK | Ngày cho sequence |
| last_seq | INTEGER | NOT NULL, DEFAULT 0 | Số sequence đã sử dụng cuối cùng |

**Sử dụng:** Mã booking được tạo dưới dạng `MSM-YYYYMMDD-XXXX` trong đó XXXX là sequence hàng ngày.

---

## Quyết định Thiết kế

1. **Không có Guest Booking**: Tất cả booking yêu cầu tài khoản nhân viên để phân bổ chi phí và theo dõi đúng cách.

2. **UUID Primary Keys**: Tất cả bảng sử dụng UUID cho primary keys để hỗ trợ hệ thống phân tán và ngăn chặn enumeration attacks.

3. **Soft Deletes**: Sử dụng cờ `is_active` thay vì hard deletes để duy trì referential integrity và audit trails.

4. **Denormalized Reporting**: Bảng `trip_reports` cung cấp dữ liệu đã tổng hợp trước cho queries báo cáo nhanh.

5. **JSONB cho Config**: Lưu trữ cấu hình linh hoạt sử dụng PostgreSQL JSONB để dễ mở rộng.

6. **GPS Time-Series Data**: `gps_locations` được phân vùng theo tháng cho writes volume cao và data retention hiệu quả.

7. **Booking Code Race Safety**: Bảng `booking_sequences` với pattern UPSERT ngăn mã trùng lặp trong concurrent inserts.

8. **Status State Machine**: Các chuyển đổi trạng thái booking được validate bởi trigger để ngăn các trạng thái không hợp lệ (ví dụ: CANCELLED → IN_PROGRESS).

9. **Comprehensive Audit Trail**: Bảng `audit_logs` tự động capture tất cả thay đổi đối với các bảng quan trọng với giá trị before/after.

10. **External Provider Tracking**: `external_dispatches` ghi nhận khi booking được fulfill bởi Grab/Taxi để phân tích chi phí.

---

## Tham khảo Enum Types

### User & Access
```sql
user_role: ADMIN, PIC, GA, DRIVER, EMPLOYEE
user_segment: DAILY, SOMETIMES
```

### Vehicles
```sql
vehicle_type: SEDAN, SUV, VAN, BUS
vehicle_status: AVAILABLE, IN_USE, MAINTENANCE, INACTIVE
```

### Locations
```sql
point_type: FIXED, FLEXIBLE
```

### Bookings
```sql
booking_type: SINGLE_TRIP, MULTI_STOP, BLOCK_SCHEDULE
booking_status: PENDING, CONFIRMED, ASSIGNED, IN_PROGRESS, COMPLETED, CANCELLED, REDIRECTED_EXTERNAL
stop_type: PICKUP, DROP, STOP
cancellation_reason: USER_REQUEST, NO_VEHICLE_AVAILABLE, NO_DRIVER_AVAILABLE, QUOTA_EXCEEDED,
                     VEHICLE_BREAKDOWN, SCHEDULE_CONFLICT, WEATHER, EMERGENCY, DUPLICATE, OTHER
```

### External Providers
```sql
external_provider: GRAB, GOJEK, BE, TAXI_MAI_LINH, TAXI_VINASUN, OTHER
```

### Operations
```sql
reading_type: TRIP_START, TRIP_END, DAILY_CHECK
shift_status: SCHEDULED, ACTIVE, COMPLETED, ABSENT, CANCELLED
maintenance_type: SCHEDULED, REPAIR, INSPECTION, TIRE_SERVICE, OIL_CHANGE, CLEANING, OTHER
```

### Notifications
```sql
notification_channel: APP_PUSH, AUTO_CALL, SMS
notification_type: BOOKING_CONFIRMED, VEHICLE_ARRIVING, TRIP_STARTED, TRIP_COMPLETED, BOOKING_CANCELLED
notification_status: PENDING, SENT, DELIVERED, FAILED
```

### Driver App
```sql
driver_response_status: PENDING, ACCEPTED, REJECTED, NO_RESPONSE
expense_type: TOLL, PARKING, FUEL, REPAIR, OTHER
trip_event_type: DRIVER_ACCEPTED, DRIVER_REJECTED, TRIP_STARTED, ARRIVED_PICKUP,
                 PASSENGER_BOARDED, ARRIVED_STOP, ARRIVED_DESTINATION, TRIP_COMPLETED,
                 ODOMETER_RECORDED, EXPENSE_ADDED, AUTO_CALL_TRIGGERED
```

---

## Entity Ứng dụng Tài xế

### Trip Expenses

Chi phí được ghi nhận bởi tài xế trong chuyến đi.

| Cột | Kiểu | Ràng buộc | Mô tả |
|-----|------|-----------|-------|
| id | UUID | PK | Primary key |
| booking_id | UUID | FK → bookings, NOT NULL | Booking liên quan |
| expense_type | ENUM | NOT NULL | Loại chi phí |
| amount | DECIMAL | NOT NULL | Số tiền chi phí |
| description | TEXT | | Mô tả chi phí |
| receipt_url | VARCHAR | | URL đến ảnh biên lai đã upload |
| recorded_by | UUID | FK → users, NOT NULL | Tài xế ghi nhận |
| recorded_at | TIMESTAMP | NOT NULL | Thời gian ghi nhận |
| approved_by | UUID | FK → users | Admin đã duyệt |
| approved_at | TIMESTAMP | | Thời gian duyệt |
| is_approved | BOOLEAN | | NULL=đang chờ, true=đã duyệt, false=từ chối |

**Giá trị Enum Expense Type:**
- `TOLL` - Phí cầu đường/cao tốc
- `PARKING` - Phí đỗ xe
- `FUEL` - Chi phí nhiên liệu
- `REPAIR` - Sửa chữa khẩn cấp
- `OTHER` - Chi phí khác

---

### Trip Events

Timeline các sự kiện trong quá trình thực hiện chuyến đi.

| Cột | Kiểu | Ràng buộc | Mô tả |
|-----|------|-----------|-------|
| id | UUID | PK | Primary key |
| booking_id | UUID | FK → bookings, NOT NULL | Booking liên quan |
| event_type | ENUM | NOT NULL | Loại sự kiện |
| event_data | JSONB | | Dữ liệu bổ sung theo sự kiện |
| latitude | DECIMAL | | Vĩ độ GPS khi sự kiện xảy ra |
| longitude | DECIMAL | | Kinh độ GPS khi sự kiện xảy ra |
| recorded_by | UUID | FK → users | Người dùng kích hoạt sự kiện |
| recorded_at | TIMESTAMP | NOT NULL | Thời gian sự kiện |

**Giá trị Enum Event Type:**
- `DRIVER_ACCEPTED` - Tài xế chấp nhận phân công
- `DRIVER_REJECTED` - Tài xế từ chối phân công
- `TRIP_STARTED` - Chuyến đi bắt đầu
- `ARRIVED_PICKUP` - Đến điểm đón
- `PASSENGER_BOARDED` - Hành khách lên xe
- `ARRIVED_STOP` - Đến điểm dừng trung gian
- `ARRIVED_DESTINATION` - Đến điểm đích cuối
- `TRIP_COMPLETED` - Chuyến đi hoàn thành
- `ODOMETER_RECORDED` - Đã ghi nhận chỉ số odometer
- `EXPENSE_ADDED` - Đã ghi nhận chi phí
- `AUTO_CALL_TRIGGERED` - Cuộc gọi tự động được kích hoạt
